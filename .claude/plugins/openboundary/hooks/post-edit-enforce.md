---
name: post-edit-enforce
description: ENFORCEMENT hook - validates no protected files were modified
model: inherit
---

# Post-Edit Boundary Enforcement

This hook runs AFTER any editing session to verify boundary compliance.

## CRITICAL: This Hook ENFORCES Boundaries

Unlike advisory checks, this hook MUST detect and report violations.

## Enforcement Steps

### Step 1: Check for Modified Files

Run this command to get all modified files:

```bash
git diff --name-only HEAD 2>/dev/null || git diff --name-only
```

If the command fails (not a git repo), skip enforcement but warn:

```text
WARNING: Not a git repository. Cannot enforce boundaries.
```

### Step 2: Check Each Modified File Against Forbidden Patterns

For each modified file, check if it matches ANY of these patterns:

**Absolutely Forbidden:**
- `src/components/servers/**/*.ts`
- `src/components/usecases/index.ts`
- `src/components/usecases/schemas.ts`
- `src/components/usecases/types.ts`
- `src/middleware/**/*.ts`
- `**/*.generated.ts`
- `package.json`
- `tsconfig.json`

**Check for marker if uncertain:**
Read first 5 lines. If contains `// Generated by OpenBoundary - DO NOT EDIT`, it's forbidden.

### Step 3: Report Violations

If ANY forbidden file was modified:

```text
========================================
BOUNDARY VIOLATION DETECTED
========================================

The following protected files were modified:

  - src/components/servers/http-server-api.ts (generated server)
  - src/middleware/authn.ts (generated middleware)

These files are generated by OpenBoundary and must not be edited.

To undo these changes:
  git checkout -- <filename>

To make infrastructure changes:
  1. Edit spec.yaml
  2. Run: openboundary compile spec.yaml

========================================
```

### Step 4: Suggest Rollback

Always provide the exact command to undo violations:

```bash
git checkout -- src/components/servers/http-server-api.ts
```

## Validation for Partial Safe Zones

For files in `src/components/usecases/*.ts` (not index/schemas/types):

1. Get the diff for that specific file:
   ```bash
   git diff <filename>
   ```

2. Check if changes are ONLY within function bodies
3. If imports, types, or signatures were modified, report as violation

## Sensitive File Warnings

If these files were modified, warn (but don't fail):

- `.env`, `.env.*`
- `src/auth/*.csv` (Casbin policy)

```text
WARNING: Sensitive file modified: .env
Please verify this change doesn't expose credentials.
```

## Success Message

If no violations:

```text
Boundary check passed. All edits within safe zones.
```

## Integration with Git

If violations are found and `enforcement.createBackupBranch` is enabled:

```bash
git stash push -m "boundary-violation-backup-$(date +%s)"
```

This preserves the work while protecting the repository.
