---
globs:
  - "**/*.ts"
  - "**/*.yaml"
  - "**/*.yml"
---

# OpenBoundary Safe Zone Rules

> **Canonical Source:** All boundary definitions are in `boundaries.json`. This document explains the rules; that file defines them.

## The Golden Rule

```text
// Generated by OpenBoundary - DO NOT EDIT
```

**If you see this marker, DO NOT EDIT the file.**

Exception: Usecase implementation bodies (code between function signature `{` and closing `}`).

## Safe Zone Reference

### Always Safe

| Pattern | Description |
|---------|-------------|
| `spec.yaml` | Main specification |
| `openboundary.yaml` | Alternative spec name |
| `openapi.yaml` | API contracts |
| `src/auth/**/*.ts` | Auth configuration |
| `src/auth/**/*.conf` | Casbin model |
| `src/auth/**/*.csv` | Casbin policy |
| `src/db/schema.ts` | Database schema |
| `src/db/seed.ts` | Seed data |

### Conditionally Safe (Partial)

| Pattern | Condition |
|---------|-----------|
| `src/components/usecases/*.ts` | Only function body, not imports/types/signatures |

**Excludes:** `index.ts`, `schemas.ts`, `types.ts`

### Never Safe (Forbidden)

| Pattern | Reason |
|---------|--------|
| `src/components/servers/**/*.ts` | Generated server code |
| `src/components/usecases/index.ts` | Generated exports |
| `src/components/usecases/schemas.ts` | Generated types |
| `src/components/usecases/types.ts` | Generated types |
| `src/middleware/**/*.ts` | Generated middleware |
| `tests/**/*.generated.ts` | Generated tests |
| `**/*.generated.ts` | Any generated file |
| `package.json` | Project config |
| `package-lock.json` | Lock file |
| `tsconfig.json` | TypeScript config |
| `Dockerfile` | Container config |
| `.github/**/*` | CI/CD workflows |

### Sensitive (Warn but Allow)

| Pattern | Warning |
|---------|---------|
| `.env`, `.env.*` | May contain credentials |
| `src/auth/*.csv` | Authorization policies - review carefully |

## Validation Steps

### Step 1: Check Path

```text
Path matches forbidden pattern?
  YES → STOP: Cannot edit this file
  NO  → Continue

Path is always safe?
  YES → PROCEED
  NO  → Continue

Path is partial safe zone (usecase)?
  YES → Go to Step 2
  NO  → STOP: Not in safe zone
```

### Step 2: For Usecase Files

1. Check filename is NOT `index.ts`, `schemas.ts`, `types.ts`
2. Read first 5 lines for `// Generated by OpenBoundary - DO NOT EDIT`
3. Locate the function body:

```typescript
export async function functionName(
  // parameters
): Promise<ReturnType> {
  // ← ONLY this section is editable
  // Everything between { and }
}
```

Do NOT edit:
- The header comment
- Import statements
- Interface/type definitions
- Function signatures
- JSDoc comments

## Why These Boundaries?

### Generated Code Will Be Overwritten

When `openboundary compile` runs, it regenerates all infrastructure. Manual changes to server files, middleware, or test scaffolding are lost.

### Type Safety Depends on Generation

Generated code maintains type safety between:
- OpenAPI schemas
- TypeScript interfaces
- Function signatures
- Database types

Manual edits break this chain.

### Security Invariants

OpenBoundary enforces:
- Middleware chains cannot be bypassed
- Authentication requirements are mandatory
- Authorization checks are automatic

Editing generated middleware could create security holes.

## What To Do Instead

| Need | Action |
|------|--------|
| Change routing | Edit `spec.yaml`, recompile |
| Change request/response types | Edit `openapi.yaml`, recompile |
| Change security rules | Edit `src/auth/policy.csv` or `model.conf` |
| Change database schema | Edit `src/db/schema.ts`, run migrations |
| Change business logic | Edit usecase function bodies |

## Violation Response

When boundary violation is attempted:

```text
BOUNDARY VIOLATION

File: src/components/servers/http-server-api.ts
Reason: Contains "// Generated by OpenBoundary - DO NOT EDIT"

This file is generated infrastructure. To modify routing:
1. Edit spec.yaml
2. Run: /ob-compile
```

## Rollback Command

To undo accidental edits to protected files:

```text
/ob-rollback
```

Or manually:

```bash
git checkout -- src/components/servers/
```
