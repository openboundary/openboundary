---
globs:
  - "**/*.ts"
  - "**/*.yaml"
  - "**/*.yml"
---

# OpenBoundary Safe Zone Rules

## The Golden Rule

```text
// Generated by OpenBoundary - DO NOT EDIT
```

**If you see this marker, DO NOT EDIT the file.**

Exception: Usecase implementation bodies (the code between the function signature and closing brace).

## Safe Zone Quick Reference

### Always Safe

| Pattern | Description |
|---------|-------------|
| `spec.yaml` | Main specification |
| `openapi.yaml` | API contracts |
| `src/auth/*.ts` | Auth configuration |
| `src/auth/*.conf` | Casbin model |
| `src/auth/*.csv` | Casbin policy |
| `src/db/schema.ts` | Database schema |

### Conditionally Safe

| Pattern | Condition |
|---------|-----------|
| `src/components/usecases/*.ts` | Only function body, not imports/types/signatures |

### Never Safe

| Pattern | Reason |
|---------|--------|
| `src/components/servers/*.ts` | Generated server code |
| `src/components/usecases/index.ts` | Generated exports |
| `src/components/usecases/schemas.ts` | Generated types |
| `src/middleware/*.ts` | Generated middleware |
| `tests/**/*.ts` | Generated tests |
| `*.generated.ts` | Any generated file |
| `package.json` | Project config |
| `tsconfig.json` | TypeScript config |

## Detecting Safe Zones

### Step 1: Check Path

```text
Is path one of?
- spec.yaml -> SAFE
- openapi.yaml -> SAFE
- src/auth/* -> SAFE
- src/db/schema.ts -> SAFE
- src/components/usecases/*.ts (not index/schemas) -> PARTIAL
- Anything else -> NOT SAFE
```

### Step 2: For Partial Safety (Usecases)

Read the file and find:

```typescript
export async function functionName(
  // parameters
): Promise<ReturnType> {
  // <-- ONLY this section is editable
  // Everything between { and } after the signature
}
```

Do NOT edit:

- The `// Generated by OpenBoundary - DO NOT EDIT` header
- Import statements
- Interface/type definitions
- Function signatures (name, parameters, return type)
- JSDoc comments

## Why These Boundaries?

### Generated Code Will Be Overwritten

When `openboundary compile` runs, it regenerates all infrastructure code. Any manual changes to server files, middleware, or test scaffolding will be lost.

### Type Safety Depends on Generation

The generated code maintains type safety between:

- OpenAPI schemas
- TypeScript interfaces
- Function signatures
- Database types

Manual edits break this chain.

### Security Invariants

OpenBoundary enforces security rules:

- Middleware chains cannot be bypassed
- Authentication requirements are mandatory
- Authorization checks are automatic

Editing generated middleware could create security holes.

## What To Do Instead

### Need to change routing?

Edit `spec.yaml` and recompile.

### Need to change request/response types?

Edit `openapi.yaml` and recompile.

### Need to change security rules?

Edit `src/auth/policy.csv` or `src/auth/model.conf`.

### Need to change database schema?

Edit `src/db/schema.ts` and run migrations.

### Need to change business logic?

Edit usecase function bodies only.

## Error Messages

When boundary violation is attempted:

```text
BOUNDARY VIOLATION

File: src/components/servers/http-server-api.ts
Reason: Contains "// Generated by OpenBoundary - DO NOT EDIT"

This file is generated infrastructure. To modify routing:
1. Edit spec.yaml
2. Run: openboundary compile spec.yaml
```
